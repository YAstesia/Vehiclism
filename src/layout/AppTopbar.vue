<script setup>
import { chatAll, chatProvince, chatSeries } from '@/api';
import { useLayout } from '@/layout/composables/layout';
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome';
import { useToast } from 'primevue/usetoast';
import { nextTick, ref } from 'vue';
import { useRouter } from 'vue-router';
import AppConfigurator from './AppConfigurator.vue';

const { onMenuToggle, toggleDarkMode, isDarkTheme } = useLayout();

const router = useRouter();
const showTooltip = ref(false);
const toast = useToast();

const handleLogout = () => {
    router.push('/');
    localStorage.removeItem('user_id');
    localStorage.removeItem('user_name');
    localStorage.removeItem('user_phone');
    localStorage.removeItem('user_email');
    localStorage.removeItem('searchQuery');
    localStorage.removeItem('salesQuery');
    localStorage.removeItem('currentPage');
    localStorage.removeItem('trim1');
    localStorage.removeItem('trim2');
    localStorage.removeItem('trim3');
    localStorage.removeItem('trim4');
    localStorage.removeItem('trim5');
};


function showSuccess() {
    toast.add({ severity: 'success', summary: 'Ê¨¢ËøéÊù•Âà∞VehiclismÊ±ΩËΩ¶‰∏ª‰πâÂ§ßÊï∞ÊçÆÂπ≥Âè∞ÔºÅ', detail: 'Êàë‰ª¨Â∏åÊúõËøô‰∏™Âπ≥Âè∞ËÉΩÊª°Ë∂≥ÊÇ®ÁöÑÊâÄÊúâÈúÄÊ±Ç„ÄÇ\n Â¶ÇÊûúÊúâ‰ªª‰ΩïÈóÆÈ¢òËØ∑Ëá¥ÁîµÔºö17321612271', life: 5000 });
}

// ÂÆö‰πâÂìçÂ∫îÂºèÂèòÈáè
const showWindow = ref(false);
const activeButton = ref('A');
const inputValue = ref('');
const dropdownValue = ref(null);
const smallInputValue = ref('');
const responseData = ref('');
const dropdownOptions = ref([
    { name: 'Âåó‰∫¨Â∏Ç', code: 'Âåó‰∫¨Â∏Ç' },
    { name: 'Â§©Ê¥•Â∏Ç', code: 'Â§©Ê¥•Â∏Ç' },
    { name: '‰∏äÊµ∑Â∏Ç', code: '‰∏äÊµ∑Â∏Ç' },
    { name: 'ÈáçÂ∫ÜÂ∏Ç', code: 'ÈáçÂ∫ÜÂ∏Ç' },
    { name: 'Ê≤≥ÂåóÁúÅ', code: 'Ê≤≥ÂåóÁúÅ' },
    { name: 'Â±±Ë•øÁúÅ', code: 'Â±±Ë•øÁúÅ' },
    { name: 'ËæΩÂÆÅÁúÅ', code: 'ËæΩÂÆÅÁúÅ' },
    { name: 'ÂêâÊûóÁúÅ', code: 'ÂêâÊûóÁúÅ' },
    { name: 'ÈªëÈæôÊ±üÁúÅ', code: 'ÈªëÈæôÊ±üÁúÅ' },
    { name: 'Ê±üËãèÁúÅ', code: 'Ê±üËãèÁúÅ' },
    { name: 'ÊµôÊ±üÁúÅ', code: 'ÊµôÊ±üÁúÅ' },
    { name: 'ÂÆâÂæΩÁúÅ', code: 'ÂÆâÂæΩÁúÅ' },
    { name: 'Á¶èÂª∫ÁúÅ', code: 'Á¶èÂª∫ÁúÅ' },
    { name: 'Ê±üË•øÁúÅ', code: 'Ê±üË•øÁúÅ' },
    { name: 'Â±±‰∏úÁúÅ', code: 'Â±±‰∏úÁúÅ' },
    { name: 'Ê≤≥ÂçóÁúÅ', code: 'Ê≤≥ÂçóÁúÅ' },
    { name: 'ÊπñÂåóÁúÅ', code: 'ÊπñÂåóÁúÅ' },
    { name: 'ÊπñÂçóÁúÅ', code: 'ÊπñÂçóÁúÅ' },
    { name: 'Âπø‰∏úÁúÅ', code: 'Âπø‰∏úÁúÅ' },
    { name: 'Êµ∑ÂçóÁúÅ', code: 'Êµ∑ÂçóÁúÅ' },
    { name: 'ÂõõÂ∑ùÁúÅ', code: 'ÂõõÂ∑ùÁúÅ' },
    { name: 'Ë¥µÂ∑ûÁúÅ', code: 'Ë¥µÂ∑ûÁúÅ' },
    { name: '‰∫ëÂçóÁúÅ', code: '‰∫ëÂçóÁúÅ' },
    { name: 'ÈôïË•øÁúÅ', code: 'ÈôïË•øÁúÅ' },
    { name: 'ÁîòËÇÉÁúÅ', code: 'ÁîòËÇÉÁúÅ' },
    { name: 'ÈùíÊµ∑ÁúÅ', code: 'ÈùíÊµ∑ÁúÅ' },
    { name: 'Âè∞ÊπæÁúÅ', code: 'Âè∞ÊπæÁúÅ' },
    { name: 'ÂÜÖËíôÂè§Ëá™Ê≤ªÂå∫', code: 'ÂÜÖËíôÂè§Ëá™Ê≤ªÂå∫' },
    { name: 'ÂπøË•øÂ£ÆÊóèËá™Ê≤ªÂå∫', code: 'ÂπøË•øÂ£ÆÊóèËá™Ê≤ªÂå∫' },
    { name: 'Ë•øËóèËá™Ê≤ªÂå∫', code: 'Ë•øËóèËá™Ê≤ªÂå∫' },
    { name: 'ÂÆÅÂ§èÂõûÊóèËá™Ê≤ªÂå∫', code: 'ÂÆÅÂ§èÂõûÊóèËá™Ê≤ªÂå∫' },
    { name: 'Êñ∞ÁñÜÁª¥ÂêæÂ∞îËá™Ê≤ªÂå∫', code: 'Êñ∞ÁñÜÁª¥ÂêæÂ∞îËá™Ê≤ªÂå∫' },
    { name: 'È¶ôÊ∏ØÁâπÂà´Ë°åÊîøÂå∫', code: 'È¶ôÊ∏ØÁâπÂà´Ë°åÊîøÂå∫' },
    { name: 'Êæ≥Èó®ÁâπÂà´Ë°åÊîøÂå∫', code: 'Êæ≥Èó®ÁâπÂà´Ë°åÊîøÂå∫' }
]);
const popupStyle = ref({});  // Áî®‰∫éÂä®ÊÄÅË∞ÉÊï¥Á™óÂè£‰ΩçÁΩÆ
const button = ref(null);    // ÂºïÁî®ÊåâÈíÆÂÖÉÁ¥†

// ÂàáÊç¢Á™óÂè£ÊòæÁ§∫Áä∂ÊÄÅ
const toggleWindow = async () => {
    showWindow.value = !showWindow.value;

    // ÂºπÁ™óÊòæÁ§∫Êó∂ÔºåÂä®ÊÄÅË∞ÉÊï¥ÂºπÁ™ó‰ΩçÁΩÆ
    if (showWindow.value) {
        await nextTick(); // Á≠âÂæÖ DOM Êõ¥Êñ∞
        // const buttonRect = button.value.getBoundingClientRect();
        popupStyle.value = {
            position: 'absolute',
            top: `0px`,  // ÊåâÈíÆ‰∏ãÊñπ
            right: `0px`,
            zIndex: 9999,                   // ‰øùËØÅÂú®È°µÈù¢È°∂Â±Ç
        };
    }
};

// ÂàáÊç¢ÊåâÈíÆÁä∂ÊÄÅ
const setActiveButton = (button) => {
    activeButton.value = button;
};

// ÂèëÈÄÅÊï∞ÊçÆÂà∞ÂêéÁ´Ø
const sendData = async () => {
    responseData.value = "Á≠âÂæÖÂõûÂ§ç‚Ä¶‚Ä¶‚Ä¶‚Ä¶";
    if (activeButton.value === 'A') {
        const response = await chatAll({ prompt: inputValue.value });
        if (response.data.success) { responseData.value = response.data.data; }
        else {
            responseData.value = "ÁΩëÁªúÈîôËØØÔºåÂäüËÉΩÊöÇÊó∂Êó†Ê≥ï‰ΩøÁî®ÔºÅ";
        }
    } else if (activeButton.value === 'B') {
        const response = await chatProvince({ region: dropdownValue.value.name, saleGroup: smallInputValue.value });
        if (response.data.success) { responseData.value = response.data.data; }
        else {
            responseData.value = "ÁΩëÁªúÈîôËØØÔºåÂäüËÉΩÊöÇÊó∂Êó†Ê≥ï‰ΩøÁî®ÔºÅ";
        }
    } else if (activeButton.value === 'C') {
        const response = await chatSeries({ seriesName: inputValue.value });
        if (response.data.success) { responseData.value = response.data.data; }
        else {
            responseData.value = "ÁΩëÁªúÈîôËØØÔºåÂäüËÉΩÊöÇÊó∂Êó†Ê≥ï‰ΩøÁî®ÔºÅ";
        }
    }
};

// Ê∏ÖÁ©∫ÂØπËØùÊ°ÜÂÜÖÂÆπ
const clearResponse = () => {
    responseData.value = '';
};

const clearInput = () => {
    inputValue.value = "";
    smallInputValue.value = "";
};

</script>

<template>
    <div class="layout-topbar">
        <div class="layout-topbar-logo-container">
            <button class="layout-menu-button layout-topbar-action" @click="onMenuToggle">
                <i class="pi pi-bars"></i>
            </button>
            <div @click="showSuccess" class="layout-topbar-logo" role="button" tabindex="0">
                <img src="/src/assets/Vehiclism_logo.png" alt="Logo" class="logo-image">
                <em class="art-text">VehiclismÊ±ΩËΩ¶‰∏ª‰πâ</em>
            </div>
        </div>

        <div class="layout-topbar-actions">
            <div class="layout-config-menu">
                <button type="button" class="layout-topbar-action" @click="toggleWindow">
                    <font-awesome-icon icon="fa-solid fa-robot" />
                </button>
                <!-- ÂºπÂá∫Á™óÂè£ -->
                <div v-if="showWindow" class="popup-window">
                    <div class="font-semibold text-xl mb-2 text-center" style="color: black;">ü§ñ VehiclismÂ∞èÂä©Êâã</div>
                    <!-- textarea Â±ïÁ§∫ÂêéÁ´ØÊï∞ÊçÆ -->
                    <Textarea v-model="responseData" placeholder="" style="height: 500px; width: 100%; resize: none;"
                        readonly />

                    <!-- A, B, C ÂàáÊç¢ÊåâÈíÆ -->
                    <div class="button-group">
                        <Button type="button" class="mr-2 mb-2" :disabled="activeButton === 'A'"
                            @click="setActiveButton('A')" label="Êô∫ËÉΩÈóÆÁ≠î" style="margin-right: 20px;" />
                        <Button type="button" class="mr-2 mb-2" :disabled="activeButton === 'B'"
                            @click="setActiveButton('B')" label="‰∏™ÊÄßÂåñÂÆöÂà∂Âª∫ËÆÆ" style="margin-right: 20px;" />
                        <Button type="button" class="mr-2 mb-2" :disabled="activeButton === 'C'"
                            @click="setActiveButton('C')" label="Êèê‰æõÈîÄÂîÆÊñπÊ°à" />
                    </div>

                    <!-- A Êàñ C ÊøÄÊ¥ªÊó∂ÊòæÁ§∫ -->
                    <div v-if="activeButton === 'A'">
                        <InputText type="text" v-model="inputValue" placeholder="ËØ∑Âú®Ê≠§ËæìÂÖ•ÊÉ≥ÊèêÈóÆÁöÑÂÜÖÂÆπÔºå‰æãÂ¶Ç‚Äú‰ªÄ‰πàÊòØÂèëÂä®Êú∫ÊéíÈáèÔºü‚Äù"
                            style="width: 100%;" />
                    </div>

                    <div v-if="activeButton === 'C'">
                        <InputText type="text" v-model="inputValue" placeholder="ËØ∑Âú®Ê≠§ËæìÂÖ•ÊÉ≥Ë¶ÅÂàÜÊûêÁöÑËΩ¶Á≥ª" style="width: 100%;" />
                    </div>

                    <!-- B ÊøÄÊ¥ªÊó∂ÊòæÁ§∫ -->
                    <div v-if="activeButton === 'B'">
                        <Select v-model="dropdownValue" style="width: 40%;" :options="dropdownOptions"
                            optionLabel="name" placeholder="ÈÄâÊã©ÁúÅ‰ªΩ" append-to="self">
                        </select>
                        <InputText type="text" v-model="smallInputValue" placeholder="ËæìÂÖ•ÊÇ®ÁöÑË∫´‰ªΩ/ËÅå‰∏ö" style="width: 60%;" />
                    </div>

                    <!-- ÂèëÈÄÅÂíåÊ∏ÖÁ©∫ÊåâÈíÆ -->
                    <div class="action-buttons">
                        <Button type="button" class="mr-2 mb-2" @click="sendData">ÂèëÈÄÅÊèêÈóÆ</button>
                        <Button type="button" class="mr-2 mb-2" @click="clearInput"
                            style="background-color: crimson; margin-left:70px;">Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü</button>
                        <Button type="button" class="mr-2 mb-2" @click="clearResponse"
                            style="background-color: crimson;">Ê∏ÖÁ©∫ÂØπËØùÊ°Ü</button>
                    </div>
                </div>
                <button type="button" class="layout-topbar-action" @click="toggleDarkMode">
                    <i :class="['pi', { 'pi-moon': isDarkTheme, 'pi-sun': !isDarkTheme }]"></i>
                </button>
                <div class="relative">
                    <button
                        v-styleclass="{ selector: '@next', enterFromClass: 'hidden', enterActiveClass: 'animate-scalein', leaveToClass: 'hidden', leaveActiveClass: 'animate-fadeout', hideOnOutsideClick: true }"
                        type="button" class="layout-topbar-action layout-topbar-action-highlight">
                        <i class="pi pi-palette"></i>
                    </button>
                    <AppConfigurator />
                </div>
            </div>

            <button class="layout-topbar-menu-button layout-topbar-action"
                v-styleclass="{ selector: '@next', enterFromClass: 'hidden', enterActiveClass: 'animate-scalein', leaveToClass: 'hidden', leaveActiveClass: 'animate-fadeout', hideOnOutsideClick: true }">
                <i class="pi pi-ellipsis-v"></i>
            </button>

            <div class="layout-topbar-menu hidden lg:block">
                <div class="layout-topbar-menu-content">
                    <button type="button" class="layout-topbar-action" @mouseover="showTooltip = true"
                        @mouseleave="showTooltip = false" @click="handleLogout">
                        <i class="pi pi-sign-out"></i>
                        <span>ÈÄÄÂá∫ÁôªÂΩï</span>
                        <div v-if="showTooltip" class="tooltip">ÈÄÄÂá∫ÁôªÂΩï</div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<style scoped>
.layout-topbar-action {
    position: relative;
}

.tooltip {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 5px;
    border-radius: 3px;
    white-space: nowrap;
    font-size: 12px;
    z-index: 10;
    pointer-events: none;
}
</style>
<style scoped>
.art-text {
    display: inline-block;
    white-space: nowrap;
    /* Âº∫Âà∂ÊñáÊú¨Âú®Âêå‰∏ÄË°åÂÜÖÊòæÁ§∫ */
    font-family: 'Arial Unicode MS', sans-serif;
    /* ÊàñËÄÖ‰ΩøÁî®ÂÖ∂‰ªñËâ∫ÊúØÂ≠ó‰Ωì */
    font-size: 1.0em;
    /* ÊîæÂ§ßÂ≠ó‰Ωì*/
    color: var(hoverBackgroundColor);
    /* Â≠ó‰ΩìÈ¢úËâ≤ */
    /* text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); */
    /* Ê∑ªÂä†Èò¥ÂΩ± */
    font-weight: bold;
    /* Âä†Á≤óÂ≠ó‰Ωì */
    letter-spacing: 1px;
    /* Â≠óÊØçÈó¥Ë∑ù */
    transition: transform 0.3s ease-in-out;
    /* ËøáÊ∏°Âä®Áîª */
}

.art-text:hover {
    transform: scale(1.1);
    /* Èº†Ê†áÊÇ¨ÂÅúÊîæÂ§ß */
}

.popup-window {
    position: absolute;
    top: 60px;
    background: white;
    border: 1px solid #000000;
    padding: 20px;
    right: 10px;
    width: 400px;
    height: 700px;
}

.button-group button {
    margin-right: 10px;
}

.action-buttons {
    margin-top: 10px;
}

.logo-image {
    max-width: 100%;
    height: 45px;
    margin-top: 10%;
    margin-bottom: 10%;
}
</style>